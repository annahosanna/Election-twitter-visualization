<!DOCTYPE html >
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>
			Twitter "Buzz" ThemeRiver
		</title>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="http://d3js.org/colorbrewer.v1.min.js"></script>

		<style type="text/css">

  path {
    stroke-width: 1;
    fill: none;
  }
  .axis {
    shape-rendering: crispEdges;
  }
  .x.axis line {
    stroke: lightgrey;
  }
  .x.axis .minor {
    stroke-opacity: .5;
  }
  .x.axis path {
    display: none;
  }
  .y.axis line, .y.axis path {
    fill: none;
    stroke: #000;
  }
	#info{
  position:absolute;
  width:100px;
  height:auto;
  padding:10px;
  background-color:white;
  border-radius:10px;
  box-shadow: 4px 4px 10px rgba(0,0,0,0.4);

}

#info.hidden{
  display:none;
}

#info p{
  margin:0px;
  font-family:sans-serif;
  font-size:12px;
}
		</style>
	</head>
	<body>
		<div id="info" class="hidden">
			<p><span id="candidate">Value 1</span></p>
		</div>
		<p> Theme River showing twitter "buzz" by state over the course of 36 weeks.</p>
		<p> In the works: nice display for weekly intervals + transitions between graphs</p>

		<p>State: <select id="stateSelect"><optgroup label="States" id="cmetrics"></optgroup></select></p>

		<script type="text/javascript">

		var margin = {
		top: 20,
		right: 30,
		bottom: 30,
		left: 40
	},
		width = 700 - margin.left - margin.right,
		height = 500 - margin.top - margin.bottom;

		var x = d3.time.scale()
			.range([0, width]);

		var y = d3.scale.linear()
			.range([height, 0]);

		var color = d3.scale.category20();

		var xAxis = d3.svg.axis()
			.scale(x)
			.orient("bottom")
			.ticks(d3.time.days);

		var yAxis = d3.svg.axis()
			.scale(y)
			.orient("left");

		var stack = d3.layout.stack()
			.offset("wiggle")
			.values(function(d) {
				return d.values;
			})
			.x(function(d) {
				return +d.date;
			})
			.y(function(d) {
				return +d.count;
			});

		var svg = d3.select("body").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var area = d3.svg.area()
			.interpolate("cardinal")
			.x(function(d) {
				return x(d.date);
			})
			.y0(function(d) {
				return y(d.y0);
			})
			.y1(function(d) {
				return y(d.y0 + d.y);
			});

		//for dropdown
		var allStates = ['Wyoming', 'Wisconsin', 'West Virginia', 'Washington DC',
			'Washington', 'Virginia', 'Vermont', 'Utah', 'Texas', 'Tennessee',
			'South Dakota', 'South Carolina', 'Rhode Island', 'Pennsylvania', 'Oregon',
			'Oklahoma', 'Ohio', 'North Dakota', 'North Carolina', 'New York',
			'New Mexico', 'New Jersey', 'New Hampshire', 'Nevada', 'Nebraska', 'Montana',
			'Missouri', 'Mississippi', 'Minnesota', 'Michigan', 'Massachusetts',
			'Maryland', 'Maine', 'Louisiana', 'Kentucky', 'Kansas', 'Iowa', 'Indiana',
			'Illinois', 'Idaho', 'Hawaii', 'Georgia', 'Florida', 'Delaware',
			'Connecticut', 'Colorado', 'California', 'Arkansas', 'Arizona', 'Alaska',
			'Alabama', 'All States'
		];

		//setup dropdown
		var stateMenu = d3.select("#cmetrics");
		for (var i = 0; i < allStates.length; i++) {
			stateMenu.append("option").attr("value", allStates[i]).text(allStates[i]);
		}

		//load data and draw initial
		d3.csv("buzz_final.csv", function(dataset) {

			//nest data by state
			var nestedDataState = d3.nest().key(function(d) {
					return d.state;
				})
				.entries(dataset);

			//default to Wyoming because the select menu starts there
			draw(nestedDataState, "Wyoming");

			//on change redraw
			d3.select("#stateSelect").on("change", function() {
				stateChoice = this.value;
				svg.selectAll("path").remove();
				draw(nestedDataState, stateChoice);
			});

		});

		var draw = function(data, choice) {

			//filter to state, returns list of one obj from nestedArray, so we index to it, and look at it's values
			var test = data.filter(function(d) {
				return d.key == choice;
			})[0].values;

			//we then nest to each candidate to create "layers" for our graph
			var nestedDataLayers = d3.nest().key(function(d) {
					return d.candidate;
				})
				.entries(test);

			//stack to get y offset
			var layers = stack(nestedDataLayers);

			//recalculate domain each time
			x.domain(d3.extent(nestedDataLayers, function(d, i) { return d.values[i].date; }));
			//finding max height of every layer in nested data
			y.domain([0, d3.max(nestedDataLayers,function(d, i) { return d3.max(d.values, function(e) { return e.y0 + e.y;})})]);

			//draw paths
			svg.selectAll(".layer")
				.data(layers)
				.enter().append("path")
				.attr("class", "layer")
				.attr("d", function(d) { return area(d.values);})
				.style("fill", function(d, i) { return color(i);});

			//mouse over / mouse out controls
			//fade other layers, show tooltip
			svg.selectAll(".layer")
				 .attr("opacity", 1)
				 .on("mouseover", function(d, i) {
					 svg.selectAll(".layer").transition()
					 .duration(250)
					 .attr("opacity", function(d, j) {
						 return j != i ? 0.6 : 1;
				 })

				 //show tooltip
				 var info = d3.select("#info");
         info.select("#candidate").text(d.key);

         var coordinates = d3.mouse(svg.node());
         var bbox = svg.node().getBoundingClientRect();
         coordinates[0] += bbox.left;
         coordinates[1] += bbox.top;

         info.style({
           left: (coordinates[0] + 25) + "px",
           top: (coordinates[1] ) + "px",
         })
         .classed("hidden", false);
			 })
				 .on("mouseout", function(d, i) {
			     svg.selectAll(".layer")
			      .transition()
			      .duration(250)
			      .attr("opacity", "1");
			      d3.select(this)
			      .classed("hover", false)
			      .attr("stroke-width", "0px");

						//hide tooltip
						var info = d3.select("#info");
						info.classed("hidden", true);
					});

			//not sure how necessary axis are to a themeriver

			// svg.append("g")
			// 		.attr("class", "x axis")
			// 		.attr("transform", "translate(0," + height + ")")
			// 		.call(xAxis);
			//
			// svg.append("g")
			// 		.attr("class", "y axis")
			// 		.call(yAxis);
		};

		</script>
	</body>
</html>
